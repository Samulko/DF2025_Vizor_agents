<!DOCTYPE html>
<html>
<head>
    <title>Bridge Design System - WebSocket Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 40px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #2563eb;
        }
        .status {
            background: #f0f9ff;
            padding: 15px;
            border-radius: 5px;
            margin: 15px 0;
        }
        .messages {
            background: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
        }
        .message {
            padding: 8px;
            margin: 4px 0;
            border-left: 4px solid #3b82f6;
            background: white;
        }
        .agent-triage { border-left-color: #2563eb; }
        .agent-geometry { border-left-color: #059669; }
        .agent-material { border-left-color: #dc2626; }
        .agent-structural { border-left-color: #ea580c; }
        .controls {
            margin: 20px 0;
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin-right: 10px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #94a3b8;
            cursor: not-allowed;
        }
        .status-indicator {
            display: inline-block;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }
        .status-connected { background: #10b981; }
        .status-disconnected { background: #ef4444; }
        .status-connecting { background: #f59e0b; }
        pre {
            background: #1f2937;
            color: #f9fafb;
            padding: 15px;
            border-radius: 5px;
            overflow-x: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üåâ Bridge Design System - WebSocket Test</h1>
        
        <div class="status">
            <h3>Connection Status</h3>
            <p>
                <span id="status-indicator" class="status-indicator status-disconnected"></span>
                <span id="status-text">Disconnected</span>
            </p>
            <p><strong>WebSocket URL:</strong> ws://localhost:8765</p>
        </div>
        
        <div class="controls">
            <button id="connect-btn" onclick="connectWebSocket()">Connect</button>
            <button id="disconnect-btn" onclick="disconnectWebSocket()" disabled>Disconnect</button>
            <button onclick="clearMessages()">Clear Messages</button>
        </div>
        
        <div class="status">
            <h3>Agent Messages</h3>
            <div id="messages" class="messages">
                <p><em>No messages yet. Connect to the WebSocket server to see real-time agent updates.</em></p>
            </div>
        </div>
        
        <div class="status">
            <h3>Usage Instructions</h3>
            <ol>
                <li>Make sure the WebSocket server is running: <code>python -m bridge_design_system.main --visualizer-server</code></li>
                <li>Click "Connect" to establish WebSocket connection</li>
                <li>Run the CLI in another terminal: <code>python -m bridge_design_system.main</code></li>
                <li>Type commands in the CLI and watch agent messages appear here in real-time!</li>
            </ol>
        </div>
        
        <div class="status">
            <h3>For React Integration</h3>
            <pre>
// Example React WebSocket connection
const ws = new WebSocket('ws://localhost:8765');

ws.onmessage = (event) => {
    const data = JSON.parse(event.data);
    console.log(`${data.agent_name} [${data.status}]: ${data.message}`);
    // Update your React state/UI here
};
            </pre>
        </div>
    </div>
    
    <script>
        let ws = null;
        const messagesDiv = document.getElementById('messages');
        const statusIndicator = document.getElementById('status-indicator');
        const statusText = document.getElementById('status-text');
        const connectBtn = document.getElementById('connect-btn');
        const disconnectBtn = document.getElementById('disconnect-btn');
        
        function updateConnectionStatus(status) {
            statusIndicator.className = 'status-indicator status-' + status;
            statusText.textContent = status.charAt(0).toUpperCase() + status.slice(1);
            
            if (status === 'connected') {
                connectBtn.disabled = true;
                disconnectBtn.disabled = false;
            } else {
                connectBtn.disabled = false;
                disconnectBtn.disabled = true;
            }
        }
        
        function connectWebSocket() {
            updateConnectionStatus('connecting');
            messagesDiv.innerHTML = '<p><em>Connecting to WebSocket server...</em></p>';
            
            try {
                ws = new WebSocket('ws://localhost:8765');
                
                ws.onopen = function() {
                    console.log('WebSocket connected');
                    updateConnectionStatus('connected');
                    messagesDiv.innerHTML = '<p style="color: green;"><strong>Connected!</strong> Waiting for agent messages...</p>';
                };
                
                ws.onmessage = function(event) {
                    console.log('Message received:', event.data);
                    try {
                        const data = JSON.parse(event.data);
                        addMessage(data);
                    } catch (e) {
                        console.error('Failed to parse message:', e);
                    }
                };
                
                ws.onerror = function(error) {
                    console.error('WebSocket error:', error);
                    updateConnectionStatus('disconnected');
                    messagesDiv.innerHTML += '<p style="color: red;"><strong>Error:</strong> Connection failed. Is the server running?</p>';
                };
                
                ws.onclose = function() {
                    console.log('WebSocket disconnected');
                    updateConnectionStatus('disconnected');
                    messagesDiv.innerHTML += '<p style="color: orange;"><strong>Disconnected</strong> from server.</p>';
                    ws = null;
                };
                
            } catch (e) {
                console.error('Failed to create WebSocket:', e);
                updateConnectionStatus('disconnected');
                messagesDiv.innerHTML = '<p style="color: red;"><strong>Error:</strong> ' + e.message + '</p>';
            }
        }
        
        function disconnectWebSocket() {
            if (ws) {
                ws.close();
            }
        }
        
        function addMessage(data) {
            const messageDiv = document.createElement('div');
            messageDiv.className = 'message agent-' + data.agent_name;
            
            const timestamp = new Date(data.timestamp).toLocaleTimeString();
            const statusIcon = getStatusIcon(data.status);
            
            messageDiv.innerHTML = `
                <strong>${timestamp}</strong> ${statusIcon} 
                <strong style="color: ${getAgentColor(data.agent_name)}">${data.agent_name.toUpperCase()}</strong> 
                [${data.status.toUpperCase()}]: ${data.message}
            `;
            
            messagesDiv.appendChild(messageDiv);
            messagesDiv.scrollTop = messagesDiv.scrollHeight;
        }
        
        function getStatusIcon(status) {
            const icons = {
                'idle': '‚≠ï',
                'thinking': 'ü§î',
                'active': 'üîÑ',
                'delegating': 'üì§',
                'error': '‚ùå'
            };
            return icons[status] || '‚óè';
        }
        
        function getAgentColor(agent) {
            const colors = {
                'triage': '#2563eb',
                'geometry': '#059669',
                'material': '#dc2626',
                'structural': '#ea580c'
            };
            return colors[agent] || '#6b7280';
        }
        
        function clearMessages() {
            messagesDiv.innerHTML = '<p><em>Messages cleared. New messages will appear here.</em></p>';
        }
        
        // Auto-connect on page load
        window.addEventListener('load', function() {
            // Don't auto-connect, let user click Connect button
            console.log('WebSocket test page loaded. Click Connect to start.');
        });
    </script>
</body>
</html>